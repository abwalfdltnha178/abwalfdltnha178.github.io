name: Update Algolia Index

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-algolia:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install --jobs 4 --retry 3

      - name: Convert Markdown to JSON and Update Algolia
        env:
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_API_KEY: ${{ secrets.ALGOLIA_ADMIN_API_KEY }}
          ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
        run: |
          mkdir -p data
          bundle exec ruby -e "
            require 'json'
            require 'kramdown'
            require 'algoliasearch'
            require 'yaml'

            # تنظیمات اتصال به Algolia
            Algolia.init(application_id: ENV['ALGOLIA_APP_ID'], api_key: ENV['ALGOLIA_ADMIN_API_KEY'])
            index = Algolia::Index.new(ENV['ALGOLIA_INDEX_NAME'])

            # خواندن فایل‌های Markdown
            markdown_files = Dir.glob('_posts/{fa,en}/*.md')
            data = markdown_files.map do |file|
              content = File.read(file)
              front_matter_content = content.match(/---(.*?)---/m)[1]
              front_matter = YAML.load(front_matter_content)

              # پردازش محتوای Markdown برای یافتن اولین تصویر
              html_content = Kramdown::Document.new(content.split('---', 3).last.strip).to_html
              first_image = html_content.match(/<img\s+[^>]

              {
                objectID: File.basename(file, '.md'),
                title: front_matter['title'],
                lang: file.include?('/fa/') ? 'fa' : 'en',
                date: front_matter['date']&.to_s, # تبدیل به رشته برای سازگاری
                categories: front_matter['categories'],
                image: first_image, # اولین تصویر از محتوای HTML
                permalink: \"/#{file.include?('/fa/') ? 'fa' : 'en'}/#{front_matter['categories'].join('/')}/#{File.basename(file, '.md')}/\",
                content: html_content # پردازش کامل محتوای Markdown
              }
            end

            # ارسال داده‌ها به Algolia
            index.add_objects(data)
            puts '✅ Data successfully updated in Algolia index!'
          "
