---
export async function getStaticPaths() {
  try {
    // اصلاح‌شده: مسیر به پوشه post/ در ریشه پروژه
    const modules = import.meta.glob('../../../post/*.md', { eager: true });
    const posts = Object.keys(modules).map((path) => {
      // استخراج نام فایل بدون پسوند به عنوان slug
      const m = path.match(/\/post\/([^\/]+)\.md$/) || path.match(/post\/([^\/]+)\.md$/);
      const slug = m ? m[1] : null;
      return slug ? { params: { slug } } : null;
    }).filter(Boolean);
    return posts;
  } catch (err) {
    console.error('getStaticPaths error:', err);
    return [];
  }
}

const { slug } = Astro.params;

// بارگذاری ماژول‌های پست‌ها (eager) با همان الگو
const modules = import.meta.glob('../../../post/*.md', { eager: true });

// پیدا کردن ماژول مربوط به slug جاری (با includes برای پوشش مسیرهای مختلف)
const entry = Object.entries(modules).find(([path]) => {
  return path.includes(`/post/${slug}.md`) || path.endsWith(`/post/${slug}.md`) || path.endsWith(`${slug}.md`);
});

if (!entry) {
  console.error(`Post not found for slug: ${slug}`);
}

const postModule = entry ? entry[1] : null;
const PostContent = postModule ? postModule.default : null;
const frontmatter = postModule?.frontmatter ?? {};
---
<!doctype html>
<html lang="fa">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{frontmatter.title ?? slug}</title>
  </head>
  <body>
    <main>
      <article>
        <h1>{frontmatter.title ?? slug}</h1>
        <p><small>{frontmatter.date ?? ''}</small></p>

        {PostContent
          ? <PostContent />
          : <section><p>پستی یافت نشد یا بارگذاری محتوا با مشکل مواجه شد.</p></section>
        }
      </article>
    </main>
  </body>
</html>
