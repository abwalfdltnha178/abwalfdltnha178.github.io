---
/*
کاری که انجام شد:
- تابع getStaticPaths را با try/catch محافظت کردم تا در صورت بروز خطا از شکست کامل build جلوگیری شود.
- برای بارگذاری پست‌ها از import.meta.glob با { eager: true } استفاده شد تا ماژول‌ها در زمان build به درستی لود شوند و از خطاهای مربوط به import در SSR جلوگیری شود.
- بررسی شد که اگر پست برای slug پیدا نشد، به جای پرتاب خطای مخفی، یک پیغام خطی لاگ شود و صفحه‌ای ساده رندر گردد تا build متوقف نشود.
- اشاره و نکته: هر کدی که به window/document نیاز دارد باید در client-only (مثلاً client:load) اجرا شود.

گام بعدی:
اگر با همین نسخه محلی build خطا داد، خروجی کامل `npm run build` را ارسال کنید یا محتوای فایل `blog/my-first-post/index.md` را بفرستید تا بررسی مستقیم انجام بدهم.
*/
export async function getStaticPaths() {
  try {
    // اگر ساختار فایل‌ها متفاوت است، این الگو را مطابق آن تغییر دهید.
    const modules = import.meta.glob('../../blog/**/index.md', { eager: true });
    const posts = Object.keys(modules).map((path) => {
      const m = path.match(/\/blog\/([^\/]+)\/index\.md$/);
      const slug = m ? m[1] : null;
      return slug ? { params: { slug } } : null;
    }).filter(Boolean);
    return posts;
  } catch (err) {
    console.error('getStaticPaths error:', err);
    // بازگرداندن آرایه خالی باعث می‌شود build ادامه یابد ولی صفحات بلاک‌شده تولید نشوند.
    return [];
  }
}

const { slug } = Astro.params;

// بارگذاری ماژول‌های پست‌ها (eager)
// در صورت نیاز path را با ساختار پروژه شما تطبیق دهید.
const modules = import.meta.glob('../../blog/**/index.md', { eager: true });

// پیدا کردن ماژول مربوط به slug جاری
const entry = Object.entries(modules).find(([path]) => path.endsWith(`/blog/${slug}/index.md`));

if (!entry) {
  // لاگ واضح برای دیباگ؛ پرتاب خطا را به‌قصد جلوگیری از متوقف‌شدن build حذف کردیم.
  console.error(`Post not found for slug: ${slug}`);
}

const postModule = entry ? entry[1] : null;
const PostContent = postModule ? postModule.default : null;
const frontmatter = postModule?.frontmatter ?? {};
---
<!doctype html>
<html lang="fa">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{frontmatter.title ?? slug}</title>
  </head>
  <body>
    <main>
      <article>
        <h1>{frontmatter.title ?? slug}</h1>
        <p><small>{frontmatter.date ?? ''}</small></p>

        {PostContent
          ? <PostContent />
          : <section><p>پستی یافت نشد یا بارگذاری محتوا با مشکل مواجه شد.</p></section>
        }

        <!-- اگر کامپوننتی دارید که به DOM نیاز دارد، آن را با client:load یا client:only لود کنید -->
        <!-- <CommentWidget client:load /> -->
      </article>
    </main>
  </body>
</html>
