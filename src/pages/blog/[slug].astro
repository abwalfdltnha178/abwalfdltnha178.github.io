---
import SmartHead from '../../components/SmartHead.astro';

/*
این نسخه:
- مسیرهای پست‌ها را از src/content/blog/*.md می‌گیرد
- برای هر slug، ماژول مربوطه را پیدا می‌کند
- از Component پیش‌فرض ماژول HTML را می‌سازد (await PostContent())
- SmartHead را با title و content مقداردهی می‌کند
- سپس محتوای واقعی پست را در body رندر می‌کند
*/

export async function getStaticPaths() {
  try {
    const modules = import.meta.glob('../../content/blog/*.md', { eager: true });
    const posts = Object.keys(modules).map((path) => {
      const m = path.match(/\/content\/blog\/([^\/]+)\.md$/) || path.match(/content\/blog\/([^\/]+)\.md$/);
      const slug = m ? m[1] : null;
      return slug ? { params: { slug } } : null;
    }).filter(Boolean);
    return posts;
  } catch (err) {
    console.error('getStaticPaths error:', err);
    return [];
  }
}

const { slug } = Astro.params;

// بارگذاری ماژول‌ها
const modules = import.meta.glob('../../content/blog/*.md', { eager: true });

// پیدا کردن ماژول بر اساس نام فایل یا frontmatter.slug
const entry = Object.entries(modules).find(([path, mod]) => {
  const fmSlug = mod?.frontmatter?.slug;
  if (fmSlug === slug) return true;
  const m = path.match(/\/content\/blog\/([^\/]+)\.md$/) || path.match(/content\/blog\/([^\/]+)\.md$/);
  const fileName = m ? m[1] : null;
  return fileName === slug;
});

if (!entry) {
  console.error(`Post not found for slug: ${slug}`);
}

const postModule = entry ? entry[1] : null;
const PostContent = postModule ? postModule.default : null;
const frontmatter = postModule?.frontmatter ?? { title: slug };

// تولید HTML رشته‌ای از محتوا (اگر ممکن است). توجه: این الگو با نسخه‌های معمول Astro Content کار می‌کند.
let contentHtml = '';
if (PostContent) {
  // اگر PostContent یک تابع/کامپوننت است، فراخوانی آن برای تولید HTML
  // این الگو در بسیاری از پروژه‌ها کار می‌کند: await PostContent()
  try {
    contentHtml = (await PostContent()) || '';
  } catch (e) {
    // fallback: سعی می‌کنیم آن را به عنوان کامپوننت رندر کنیم در template
    contentHtml = '';
  }
}
---
<!doctype html>
<html lang="fa">
  <SmartHead title={frontmatter.title} content={contentHtml} />
  <body>
    <main>
      <article>
        <h1>{frontmatter.title}</h1>
        <p><small>{frontmatter.date ?? ''}</small></p>

        {PostContent
          ? <PostContent />
          : <section><p>پستی یافت نشد یا بارگذاری محتوا با مشکل مواجه شد.</p></section>
        }
      </article>
    </main>
  </body>
</html>
